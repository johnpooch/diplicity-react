# Context: iOS CI/CD for Diplicity React

I'm working on a full-stack Diplomacy board game app called **Diplicity React**. I want to set up CI/CD for the iOS app so that changes to `main` automatically produce a new iOS release, and I can also produce test builds. I'd like your help thinking through the approach.

## What the project is

A Diplomacy board game web + mobile app:
- **Frontend**: React 19 + TypeScript + Vite web app at `/packages/web/`
- **Backend**: Django REST API at `/service/`
- **iOS**: Capacitor wraps the web app into a native iOS app
- **Infrastructure**: Docker Compose locally, Railway + Azure in production

The iOS app is essentially a native shell (Capacitor) around the web build. The web app is built with `npm run build` (produces `/packages/web/dist/`), then `npx cap sync ios` copies those web assets into the native iOS project. Then the Xcode project at `packages/web/ios/App/App.xcodeproj` is built and signed.

## Current iOS project details

**Bundle ID**: `com.diplicity.app`
**Team ID**: `G76UP8FNMS`
**Scheme**: `App`
**Xcode project path**: `packages/web/ios/App/App.xcodeproj` (no .xcworkspace)
**Swift Package Manager**: Dependencies managed via `packages/web/ios/App/CapApp-SPM/Package.swift`
**Min iOS version**: 15
**Code signing**: Xcode automatic signing (`CODE_SIGN_STYLE = Automatic`)
**Current version**: `MARKETING_VERSION = 1.0`, `CURRENT_PROJECT_VERSION = 1`

**Info.plist** uses build setting variables:
- `CFBundleShortVersionString` = `$(MARKETING_VERSION)` — the user-visible version (e.g., "1.2.0")
- `CFBundleVersion` = `$(CURRENT_PROJECT_VERSION)` — the build number (must be unique per upload)

**Dependencies** (Swift Package Manager via CapApp-SPM):
- `capacitor-swift-pm` (Capacitor 8.1.0)
- Currently no other native dependencies (PR #189 would add `@capgo/capacitor-social-login`)

**Gitignored iOS files**:
- `packages/web/ios/App/build/`
- `packages/web/ios/App/App/public/` (generated by cap sync)
- `*.mobileprovision`, `*.cer`
- `AuthKey*` (APNs keys)

## Current CI/CD (web + backend only, no iOS)

There is NO existing iOS CI/CD. Here's what exists today:

### GitHub Actions workflows:

**`build-and-deploy-service.yml`** (on push to main):
- Builds Django Docker image
- Deploys to Azure Container Registry + Web App
- Deploys to Railway via Railway CLI
- Waits for both to be healthy

**`build-and-deploy-web.yml`** (on push to main):
- Builds web frontend (`npm run build`)
- Deploys to Azure Static Web Apps

**`test-service.yml`** (on PRs): Runs Django tests
**`test-e2e.yml`** (on PRs): Runs Playwright E2E tests

### Build commands for iOS (currently manual):
```bash
cd packages/web
npm run build                    # Build web assets
npx cap sync ios                 # Copy web assets to iOS project
xcodebuild -project ios/App/App.xcodeproj -scheme App \
  -destination 'id=<DEVICE_UDID>' \
  -allowProvisioningUpdates \
  DEVELOPMENT_TEAM=G76UP8FNMS CODE_SIGN_STYLE=Automatic \
  build
```

## Apple credentials and signing

- **Apple Development cert**: `Apple Development: John McDowell (P96LAJ7FF8)` — for device builds
- **Apple Distribution cert**: `Apple Distribution: John McDowell (G76UP8FNMS)` — for App Store (created Feb 2026, expires Feb 2027)
- **Xcode automatic signing** is used — Xcode manages provisioning profiles
- **APNs auth key**: `AuthKey_C6JM6K4J2X.p8` (Key ID: `C6JM6K4J2X`) — for push notifications, independent of distribution certs
- **No Fastlane** or Match currently set up
- **No App Store Connect API key** currently set up

## Environment variables needed for builds

```
# Google OAuth (needed for web build)
VITE_GOOGLE_CLIENT_ID="..."
VITE_GOOGLE_IOS_CLIENT_ID="..."  (from PR #189)

# API URL
VITE_DIPLICITY_API_BASE_URL="https://diplicity-react-production.up.railway.app"

# Firebase (for push notifications)
VITE_FIREBASE_API_KEY="..."
VITE_FIREBASE_AUTH_DOMAIN="..."
VITE_FIREBASE_PROJECT_ID="..."
VITE_FIREBASE_STORAGE_BUCKET="..."
VITE_FIREBASE_MESSAGING_SENDER_ID="..."
VITE_FIREBASE_APP_ID="..."

# Sentry/Honeycomb (optional for builds)
VITE_SENTRY_DSN="..."
VITE_HONEYCOMB_API_KEY="..."
```

## What I want to achieve

1. **Automatic App Store release**: When code is merged to `main`, automatically build the iOS app, increment the version/build number, and submit to App Store Connect (either for review or as a build that can be manually released).

2. **Test builds**: Be able to create test builds (TestFlight or ad-hoc) for QA testing before merging to main, or from specific branches.

## Questions I'm thinking about

- Should I use Fastlane or just raw xcodebuild + altool/xcrun commands?
- How should I handle code signing in CI? (Match? Manual cert management? App Store Connect API key?)
- How should versioning work? (Semantic versioning? Auto-increment build numbers?)
- Should I use GitHub Actions with macOS runners, or a service like Codemagic/Bitrise?
- How do I handle the Apple certificates and provisioning profiles securely in CI?
- What's the best TestFlight workflow for test builds?
- How does this interact with the Capacitor build process?
- Is there anything Capacitor-specific I need to worry about for CI?

## Previous iOS progress

There's an existing planning document (`docs/capacitor-work-overview-draft.md`) that outlines the full Capacitor integration work. Key context:

- **Previous App Store submission**: Before a machine wipe, an App Store Connect record was created with metadata, privacy labels, and at least one build was successfully uploaded. The distribution profile and provisioning profile were created. The source code changes were lost but the App Store Connect record should still exist.
- **PR #189** (currently open) implements native Google Sign-In for iOS using `@capgo/capacitor-social-login`, which is one of the planned work items (C3/C4).
- **Remaining iOS work items** from the plan include: push notification integration (C5), safe area styling (C6), deep linking (C7), and App Store preparation (D1).
- The plan identifies **C1 (build pipeline)** as the key enabler that unlocks most downstream work — which is essentially what I'm asking about here.

## Google OAuth URL scheme

The Info.plist has a URL scheme registered for Google OAuth:
```
com.googleusercontent.apps.394867503899-gpu4vouhophf31hejbu0ovlsndobnp7u
```

## Constraints

- The app is not yet publicly released on the App Store, but an App Store Connect record exists from a previous attempt
- I'm an individual developer (not an organization), using personal Apple Developer account
- The repo is on GitHub (github.com/johnpooch/diplicity-react)
- Budget-conscious — prefer free/cheap solutions where possible
- I use Xcode automatic signing locally and would like the CI approach to be as simple as possible
- macOS runners on GitHub Actions cost 10x Linux runners ($0.08/min vs $0.008/min)

Please help me think through the best approach for setting up iOS CI/CD for this project. I'm open to discussing trade-offs between different tools and approaches.
